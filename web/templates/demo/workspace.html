<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>RegelRecht Demo Mode - Workspace</title>
        <link rel="stylesheet" href="/static/css/demo.css">
        <script defer
                src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js"></script>
        <style>
        [x-cloak] {
            display: none !important;
        }
        </style>
    </head>
    <body>
        <div class="workspace-container" x-data="workspaceData()" x-init="init()">
            <!-- Tab Bar (Browser-like) -->
            <div class="tab-bar">
                <div class="tab"
                     :class="{ 'active': activeTab === 'laws' }"
                     @click="switchTab('laws')">
                    <span class="tab-label">Wetten</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'features' }"
                     @click="switchTab('features')">
                    <span class="tab-label">Features</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'graph' }"
                     @click="switchTab('graph')">
                    <span class="tab-label">Graaf analyse</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'burger' }"
                     @click="switchTab('burger')">
                    <span class="tab-label">Burger.nl</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'zaaksysteem' }"
                     @click="switchTab('zaaksysteem')">
                    <span class="tab-label">Zaaksysteem</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'simulatie' }"
                     @click="switchTab('simulatie')">
                    <span class="tab-label">Simulatie</span>
                </div>
            </div>
            <!-- Tab Content Container -->
            <div class="tab-content-wrapper">
                <!-- Laws Tab Content (Embedded) -->
                <div class="tab-content"
                     x-show="activeTab === 'laws'"
                     x-cloak
                     id="laws-content">
                    <div x-html="lawsContent"></div>
                </div>
                <!-- Features Tab Content (Embedded) -->
                <div class="tab-content"
                     x-show="activeTab === 'features'"
                     x-cloak
                     id="features-content">
                    <div x-html="featuresContent"></div>
                </div>
                <!-- Graph Analysis Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'graph'"
                     x-cloak>
                    <iframe src="/analysis/graph/"
                            frameborder="0"
                            class="tab-iframe"
                            title="Graph Analysis"></iframe>
                </div>
                <!-- Burger.nl Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'burger'"
                     x-cloak>
                    <iframe src="/" frameborder="0" class="tab-iframe" title="Burger.nl"></iframe>
                </div>
                <!-- Zaaksysteem Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'zaaksysteem'"
                     x-cloak>
                    <iframe src="/admin/toeslagen"
                            frameborder="0"
                            class="tab-iframe"
                            title="Zaaksysteem"></iframe>
                </div>
                <!-- Simulatie Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'simulatie'"
                     x-cloak>
                    <iframe src="/simulation/"
                            frameborder="0"
                            class="tab-iframe"
                            title="Simulatie"></iframe>
                </div>
            </div>
        </div>
        <!-- JavaScript -->
        <script src="/static/js/demo.js"></script>
        <script>
        function workspaceData() {
            return {
                activeTab: 'laws',
                lawsContent: '',
                featuresContent: '',
                lawsLoaded: false,
                featuresLoaded: false,

                init() {
                    // Check URL hash first
                    const hash = window.location.hash.substring(1);
                    const validTabs = ['laws', 'features', 'graph', 'burger', 'zaaksysteem', 'simulatie'];

                    if (hash && validTabs.includes(hash)) {
                        this.activeTab = hash;
                    } else {
                        // Check localStorage
                        const savedTab = localStorage.getItem('activeTab');
                        if (savedTab && validTabs.includes(savedTab)) {
                            this.activeTab = savedTab;
                        }
                    }

                    // Load initial content for active tab
                    this.loadTabContent(this.activeTab);

                    // Listen for hash changes (browser back/forward)
                    window.addEventListener('hashchange', () => {
                        const newHash = window.location.hash.substring(1);
                        if (newHash && validTabs.includes(newHash)) {
                            this.activeTab = newHash;
                            this.loadTabContent(newHash);
                        }
                    });
                },

                switchTab(tab) {
                    this.activeTab = tab;

                    // Update URL hash
                    window.location.hash = tab;

                    // Save to localStorage
                    localStorage.setItem('activeTab', tab);

                    // Load content if needed
                    this.loadTabContent(tab);
                },

                async loadTabContent(tab, url = null) {
                    // Load laws content
                    if (tab === 'laws') {
                        if (!this.lawsLoaded || url) {
                            try {
                                const fetchUrl = url || '/demo/workspace/laws';
                                const response = await fetch(fetchUrl);
                                this.lawsContent = await response.text();
                                this.lawsLoaded = true;

                                // After content loads, attach click handlers and init sidebar
                                this.$nextTick(() => {
                                    this.attachLawClickHandlers();
                                    this.initLawsSidebar();
                                });
                            } catch (error) {
                                console.error('Error loading laws content:', error);
                                this.lawsContent = '<div class="error-message">Error loading laws content</div>';
                            }
                        }
                    }

                    // Load features content
                    if (tab === 'features') {
                        if (!this.featuresLoaded || url) {
                            try {
                                const fetchUrl = url || '/demo/workspace/features';
                                const response = await fetch(fetchUrl);
                                this.featuresContent = await response.text();
                                this.featuresLoaded = true;

                                // After content loads, attach click handlers and init sidebar
                                this.$nextTick(() => {
                                    this.attachFeatureClickHandlers();
                                    this.initFeaturesSidebar();
                                });
                            } catch (error) {
                                console.error('Error loading features content:', error);
                                this.featuresContent = '<div class="error-message">Error loading features content</div>';
                            }
                        }
                    }

                    // IFrame-based tabs load on demand automatically via x-show
                },

                initLawsSidebar() {
                    const sidebar = document.getElementById('laws-sidebar');
                    const collapsedToggle = document.getElementById('laws-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) {
                        console.warn('Laws sidebar elements not found');
                        return;
                    }

                    const savedState = localStorage.getItem('lawsSidebarCollapsed');
                    const isCollapsed = savedState === null ? true : savedState === 'true';

                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        collapsedToggle.style.display = 'block';
                        sidebarToggle.style.display = 'none';
                    } else {
                        sidebar.classList.remove('collapsed');
                        collapsedToggle.style.display = 'none';
                        sidebarToggle.style.display = 'block';
                    }

                    // Attach event listeners to toggle buttons
                    collapsedToggle.onclick = () => this.toggleLawsSidebar();
                    sidebarToggle.onclick = () => this.toggleLawsSidebar();
                },

                toggleLawsSidebar() {
                    const sidebar = document.getElementById('laws-sidebar');
                    const collapsedToggle = document.getElementById('laws-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) return;

                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');

                    collapsedToggle.style.display = isCollapsed ? 'block' : 'none';
                    sidebarToggle.style.display = isCollapsed ? 'none' : 'block';

                    localStorage.setItem('lawsSidebarCollapsed', isCollapsed);
                },

                initFeaturesSidebar() {
                    const sidebar = document.getElementById('features-sidebar');
                    const collapsedToggle = document.getElementById('features-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) {
                        console.warn('Features sidebar elements not found');
                        return;
                    }

                    const savedState = localStorage.getItem('featuresSidebarCollapsed');
                    const isCollapsed = savedState === null ? true : savedState === 'true';

                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        collapsedToggle.style.display = 'block';
                        sidebarToggle.style.display = 'none';
                    } else {
                        sidebar.classList.remove('collapsed');
                        collapsedToggle.style.display = 'none';
                        sidebarToggle.style.display = 'block';
                    }

                    // Attach event listeners to toggle buttons
                    collapsedToggle.onclick = () => this.toggleFeaturesSidebar();
                    sidebarToggle.onclick = () => this.toggleFeaturesSidebar();
                },

                toggleFeaturesSidebar() {
                    const sidebar = document.getElementById('features-sidebar');
                    const collapsedToggle = document.getElementById('features-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) return;

                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');

                    collapsedToggle.style.display = isCollapsed ? 'block' : 'none';
                    sidebarToggle.style.display = isCollapsed ? 'none' : 'block';

                    localStorage.setItem('featuresSidebarCollapsed', isCollapsed);
                },

                attachLawClickHandlers() {
                    // Intercept law links to load within tab
                    const lawLinks = document.querySelectorAll('#laws-content a[href^="/demo/law/"]');
                    lawLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            this.loadTabContent('laws', href.replace('/demo/law/', '/demo/workspace/law/'));
                        });
                    });
                },

                attachFeatureClickHandlers() {
                    // Intercept feature links to load within tab
                    const featureLinks = document.querySelectorAll('#features-content a[href^="/demo/feature/"]');
                    featureLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            this.loadTabContent('features', href.replace('/demo/feature/', '/demo/workspace/feature/'));
                        });
                    });
                }
            }
        }
        </script>
    </body>
</html>
