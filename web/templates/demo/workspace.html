<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>RegelRecht Demo Mode - Workspace</title>
        <link rel="stylesheet" href="/static/css/demo.css">
        <script defer
                src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js"></script>
        <style>
        [x-cloak] {
            display: none !important;
        }
        </style>
    </head>
    <body>
        <div class="workspace-container" x-data="workspaceData()" x-init="init()">
            <!-- Tab Bar (Browser-like) -->
            <div class="tab-bar">
                <div class="tab"
                     :class="{ 'active': activeTab === 'laws' }"
                     @click="switchTab('laws')">
                    <span class="tab-label">Wetten</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'features' }"
                     @click="switchTab('features')">
                    <span class="tab-label">Scenarios</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'graph' }"
                     @click="switchTab('graph')">
                    <span class="tab-label">Graaf analyse</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'burger' }"
                     @click="switchTab('burger')">
                    <span class="tab-label">Burger.nl</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'zaaksysteem' }"
                     @click="switchTab('zaaksysteem')">
                    <span class="tab-label">Zaaksysteem</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'simulatie' }"
                     @click="switchTab('simulatie')">
                    <span class="tab-label">Simulatie</span>
                </div>
            </div>
            <!-- Tab Content Container -->
            <div class="tab-content-wrapper">
                <!-- Laws Tab Content (Embedded) -->
                <div class="tab-content"
                     x-show="activeTab === 'laws'"
                     x-cloak
                     id="laws-content">
                    <div x-html="lawsContent"></div>
                </div>
                <!-- Features Tab Content (Embedded) -->
                <div class="tab-content"
                     x-show="activeTab === 'features'"
                     x-cloak
                     id="features-content">
                    <div x-html="featuresContent"></div>
                </div>
                <!-- Graph Analysis Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'graph'"
                     x-cloak>
                    <iframe src="/analysis/graph/"
                            frameborder="0"
                            class="tab-iframe"
                            title="Graph Analysis"></iframe>
                </div>
                <!-- Burger.nl Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'burger'"
                     x-cloak>
                    <iframe src="/" frameborder="0" class="tab-iframe" title="Burger.nl"></iframe>
                </div>
                <!-- Zaaksysteem Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'zaaksysteem'"
                     x-cloak>
                    <iframe src="/admin/toeslagen"
                            frameborder="0"
                            class="tab-iframe"
                            title="Zaaksysteem"></iframe>
                </div>
                <!-- Simulatie Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'simulatie'"
                     x-cloak>
                    <iframe src="/simulation/"
                            frameborder="0"
                            class="tab-iframe"
                            title="Simulatie"></iframe>
                </div>
            </div>
        </div>
        <!-- JavaScript -->
        <script src="/static/js/demo.js"></script>
        <script>
        // Global variables for feature testing (needed by feature_viewer_partial.html)
        let currentFeaturePath = '';
        let currentRunId = null;
        let pollInterval = null;

        // Global functions for feature scenarios (called by onclick handlers in rendered HTML)
        function toggleScenario(element) {
            const scenario = element.closest('.gherkin-scenario');
            if (!scenario) return;

            scenario.classList.toggle('collapsed');
            const icon = element.querySelector('.collapse-icon');
            if (icon) {
                icon.textContent = scenario.classList.contains('collapsed') ? '▶' : '▼';
            }
        }

        function expandAllScenarios() {
            document.querySelectorAll('.gherkin-scenario').forEach(scenario => {
                scenario.classList.remove('collapsed');
                const icon = scenario.querySelector('.collapse-icon');
                if (icon) icon.textContent = '▼';
            });
        }

        function collapseAllScenarios() {
            document.querySelectorAll('.gherkin-scenario').forEach(scenario => {
                scenario.classList.add('collapsed');
                const icon = scenario.querySelector('.collapse-icon');
                if (icon) icon.textContent = '▶';
            });
        }

        async function runScenario(scenarioIndex) {
            const outputContent = document.getElementById('output-content');
            outputContent.innerHTML = '<div class="output-running">Running scenario...</div>';

            try {
                const response = await fetch('/demo/feature/run-scenario', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        feature_path: currentFeaturePath,
                        scenario_index: parseInt(scenarioIndex)
                    })
                });

                const data = await response.json();
                currentRunId = data.run_id;

                // Start polling for output
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(pollForOutput, 500);

            } catch (error) {
                outputContent.innerHTML = `<div class="output-error">Error: ${error.message}</div>`;
            }
        }

        function filterOutput(output) {
            if (!output) return '';

            const lines = output.split('\n');
            let startIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (/\.py:\d+/.test(lines[i])) {
                    console.log('Found start line at index', i, ':', lines[i]);
                    startIndex = i;
                    break;
                }
            }

            if (startIndex >= 0) {
                const filtered = lines.slice(startIndex).join('\n');
                console.log('Filtered output from line', startIndex, 'length:', filtered.length);
                return filtered;
            }

            console.log('No filter marker found, returning full output');
            return output;
        }

        async function pollForOutput() {
            if (!currentRunId) return;

            try {
                const response = await fetch(`/demo/feature/run-status/${currentRunId}`);
                const data = await response.json();

                const outputContent = document.getElementById('output-content');
                const filteredOutput = filterOutput(data.output);
                outputContent.innerHTML = `<pre class="output-text">${filteredOutput}</pre>`;

                // Auto-scroll to bottom
                outputContent.scrollTop = outputContent.scrollHeight;

                // Update status
                const statusEl = document.getElementById('scenario-status');
                if (data.status === 'completed') {
                    statusEl.textContent = '✅ Passed';
                    statusEl.className = 'scenario-status passed';
                    clearInterval(pollInterval);
                } else if (data.status === 'failed') {
                    statusEl.textContent = '❌ Failed';
                    statusEl.className = 'scenario-status failed';
                    clearInterval(pollInterval);
                } else {
                    statusEl.textContent = '⏳ Running...';
                    statusEl.className = 'scenario-status running';
                }

            } catch (error) {
                console.error('Error polling output:', error);
                clearInterval(pollInterval);
            }
        }

        async function runAllScenarios() {
            const outputContent = document.getElementById('output-content');
            outputContent.innerHTML = '<div class="output-running">Running all scenarios...</div>';

            try {
                const response = await fetch('/demo/run-feature', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        feature_path: currentFeaturePath
                    })
                });

                const data = await response.json();
                currentRunId = data.run_id;

                // Start polling for output
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(pollForOutput, 500);

            } catch (error) {
                outputContent.innerHTML = `<div class="output-error">Error: ${error.message}</div>`;
            }
        }

        function clearOutput() {
            document.getElementById('output-content').innerHTML =
                '<div class="output-placeholder">Run a scenario to see output here...</div>';
            document.getElementById('scenario-status').textContent = '';
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function workspaceData() {
            return {
                activeTab: 'laws',
                lawsContent: '',
                featuresContent: '',
                lawsLoaded: false,
                featuresLoaded: false,

                init() {
                    // Check URL hash first
                    const hash = window.location.hash.substring(1);
                    const validTabs = ['laws', 'features', 'graph', 'burger', 'zaaksysteem', 'simulatie'];

                    if (hash && validTabs.includes(hash)) {
                        this.activeTab = hash;
                    } else {
                        // Check localStorage
                        const savedTab = localStorage.getItem('activeTab');
                        if (savedTab && validTabs.includes(savedTab)) {
                            this.activeTab = savedTab;
                        }
                    }

                    // Load initial content for active tab
                    this.loadTabContent(this.activeTab);

                    // Listen for hash changes (browser back/forward)
                    window.addEventListener('hashchange', () => {
                        const newHash = window.location.hash.substring(1);
                        if (newHash && validTabs.includes(newHash)) {
                            this.activeTab = newHash;
                            this.loadTabContent(newHash);
                        }
                    });
                },

                switchTab(tab) {
                    this.activeTab = tab;

                    // Update URL hash
                    window.location.hash = tab;

                    // Save to localStorage
                    localStorage.setItem('activeTab', tab);

                    // Load content if needed
                    this.loadTabContent(tab);
                },

                async loadTabContent(tab, url = null) {
                    // Load laws content
                    if (tab === 'laws') {
                        if (!this.lawsLoaded || url) {
                            try {
                                const fetchUrl = url || '/demo/workspace/laws';
                                const response = await fetch(fetchUrl);
                                this.lawsContent = await response.text();
                                this.lawsLoaded = true;

                                // After content loads, attach click handlers and init sidebar
                                this.$nextTick(() => {
                                    this.attachLawClickHandlers();
                                    this.initLawsSidebar();
                                });
                            } catch (error) {
                                console.error('Error loading laws content:', error);
                                this.lawsContent = '<div class="error-message">Error loading laws content</div>';
                            }
                        }
                    }

                    // Load features content
                    if (tab === 'features') {
                        if (!this.featuresLoaded || url) {
                            try {
                                const fetchUrl = url || '/demo/workspace/features';
                                const response = await fetch(fetchUrl);
                                this.featuresContent = await response.text();
                                this.featuresLoaded = true;

                                // Extract feature path from URL for global variable
                                if (url) {
                                    // URL format: /demo/workspace/feature/{feature_path}
                                    const match = url.match(/\/demo\/workspace\/feature\/(.+)/);
                                    if (match) {
                                        currentFeaturePath = match[1];
                                    }
                                } else {
                                    // Default feature path
                                    currentFeaturePath = 'submodules/regelrecht-laws/laws/zorgtoeslagwet/TOESLAGEN-2025-01-01.feature';
                                }

                                // After content loads, attach click handlers and init sidebar
                                this.$nextTick(() => {
                                    this.attachFeatureClickHandlers();
                                    this.initFeaturesSidebar();
                                });
                            } catch (error) {
                                console.error('Error loading features content:', error);
                                this.featuresContent = '<div class="error-message">Error loading features content</div>';
                            }
                        }
                    }

                    // IFrame-based tabs load on demand automatically via x-show
                },

                initLawsSidebar() {
                    const sidebar = document.getElementById('laws-sidebar');
                    const collapsedToggle = document.getElementById('laws-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) {
                        console.warn('Laws sidebar elements not found');
                        return;
                    }

                    const savedState = localStorage.getItem('lawsSidebarCollapsed');
                    const isCollapsed = savedState === null ? true : savedState === 'true';

                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        collapsedToggle.style.display = 'block';
                        sidebarToggle.style.display = 'none';
                    } else {
                        sidebar.classList.remove('collapsed');
                        collapsedToggle.style.display = 'none';
                        sidebarToggle.style.display = 'block';
                    }

                    // Attach event listeners to toggle buttons
                    collapsedToggle.onclick = () => this.toggleLawsSidebar();
                    sidebarToggle.onclick = () => this.toggleLawsSidebar();
                },

                toggleLawsSidebar() {
                    const sidebar = document.getElementById('laws-sidebar');
                    const collapsedToggle = document.getElementById('laws-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) return;

                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');

                    collapsedToggle.style.display = isCollapsed ? 'block' : 'none';
                    sidebarToggle.style.display = isCollapsed ? 'none' : 'block';

                    localStorage.setItem('lawsSidebarCollapsed', isCollapsed);
                },

                initFeaturesSidebar() {
                    const sidebar = document.getElementById('features-sidebar');
                    const collapsedToggle = document.getElementById('features-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) {
                        console.warn('Features sidebar elements not found');
                        return;
                    }

                    const savedState = localStorage.getItem('featuresSidebarCollapsed');
                    const isCollapsed = savedState === null ? true : savedState === 'true';

                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        collapsedToggle.style.display = 'block';
                        sidebarToggle.style.display = 'none';
                    } else {
                        sidebar.classList.remove('collapsed');
                        collapsedToggle.style.display = 'none';
                        sidebarToggle.style.display = 'block';
                    }

                    // Attach event listeners to toggle buttons
                    collapsedToggle.onclick = () => this.toggleFeaturesSidebar();
                    sidebarToggle.onclick = () => this.toggleFeaturesSidebar();
                },

                toggleFeaturesSidebar() {
                    const sidebar = document.getElementById('features-sidebar');
                    const collapsedToggle = document.getElementById('features-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) return;

                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');

                    collapsedToggle.style.display = isCollapsed ? 'block' : 'none';
                    sidebarToggle.style.display = isCollapsed ? 'none' : 'block';

                    localStorage.setItem('featuresSidebarCollapsed', isCollapsed);
                },

                attachLawClickHandlers() {
                    // Intercept law links to load within tab
                    const lawLinks = document.querySelectorAll('#laws-content a[href^="/demo/law/"]');
                    lawLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            this.loadTabContent('laws', href.replace('/demo/law/', '/demo/workspace/law/'));
                        });
                    });
                },

                attachFeatureClickHandlers() {
                    // Intercept feature links to load within tab
                    const featureLinks = document.querySelectorAll('#features-content a[href^="/demo/feature/"]');
                    featureLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            this.loadTabContent('features', href.replace('/demo/feature/', '/demo/workspace/feature/'));
                        });
                    });
                }
            }
        }
        </script>
    </body>
</html>
