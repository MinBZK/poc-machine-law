<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>RegelRecht Demo Mode - Workspace</title>
        <link rel="stylesheet" href="/static/css/demo.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.10/htmx.min.js"></script>
        <script defer
                src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js"></script>
        <style>
        [x-cloak] {
            display: none !important;
        }
        .temp-tab-close {
            margin-left: 8px;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0.6;
            padding: 0 4px;
        }
        .temp-tab-close:hover {
            opacity: 1;
            color: #e74c3c;
        }
        </style>
    </head>
    <body>
        <div class="workspace-container" x-data="workspaceData()" x-init="init()">
            <!-- Tab Bar (Browser-like) -->
            <div class="tab-bar">
                <div class="tab"
                     :class="{ 'active': activeTab === 'presentatie' }"
                     @click="switchTab('presentatie')">
                    <span class="tab-label">Presentatie</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'laws' }"
                     @click="switchTab('laws')">
                    <span class="tab-label">Wetten</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'graph' }"
                     @click="switchTab('graph')">
                    <span class="tab-label">Graaf analyse</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'features' }"
                     @click="switchTab('features')">
                    <span class="tab-label">Scenarios</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'simulatie' }"
                     @click="switchTab('simulatie')">
                    <span class="tab-label">Simulatie</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'burger' }"
                     @click="switchTab('burger')">
                    <span class="tab-label">Burger.nl</span>
                </div>
                <div class="tab"
                     :class="{ 'active': activeTab === 'zaaksysteem' }"
                     @click="switchTab('zaaksysteem')">
                    <span class="tab-label">Zaaksysteem</span>
                </div>
                <!-- Temporary Tabs (dismissable) -->
                <template x-for="tab in temporaryTabs" :key="tab.id">
                    <div class="tab"
                         :class="{ 'active': activeTab === tab.id }"
                         @click="switchTab(tab.id)">
                        <span class="tab-label" x-text="tab.name"></span>
                        <button class="temp-tab-close"
                                @click.stop="closeTemporaryTab(tab.id)"
                                title="Sluiten">√ó</button>
                    </div>
                </template>
                <!-- Hamburger Menu Button -->
                <div class="demo-menu">
                    <button class="menu-toggle" @click.stop="menuOpen = !menuOpen" title="Menu">‚ãÆ</button>
                </div>
            </div>
            <!-- Second Row: Law Tabs (only visible when activeTab === 'laws') -->
            <div class="law-tab-bar"
                 x-show="activeTab === 'laws' && openedLawTabs.length > 0"
                 x-cloak>
                <div class="law-tabs-container">
                    <template x-for="lawTab in openedLawTabs" :key="lawTab.id">
                        <div class="law-tab"
                             :class="{ 'active': activeLawTabId === lawTab.id }"
                             @click="switchLawTab(lawTab.id)">
                            <span class="law-tab-label" x-text="lawTab.name"></span>
                            <button class="law-tab-close"
                                    @click.stop="closeLawTab(lawTab.id)"
                                    title="Close tab">√ó</button>
                        </div>
                    </template>
                </div>
                <button class="law-tabs-clear-all"
                        @click="closeAllLawTabs()"
                        x-show="openedLawTabs.length > 1"
                        title="Alle wetten-tabs sluiten">Alles wissen</button>
            </div>
            <!-- Tab Content Container -->
            <div class="tab-content-wrapper">
                <!-- Presentation Tab Content -->
                <div class="tab-content presentation-content"
                     x-show="activeTab === 'presentatie'"
                     x-cloak>
                    <div class="presentation-container">
                        <!-- Slide 1: Title -->
                        <div class="slide" x-show="currentSlide === 0" x-cloak>
                            <div class="slide-content title-slide">
                                <h1>RegelRecht</h1>
                                <p class="slide-subtitle">van wet naar digitale werking</p>
                                <div class="slide-footer">
                                    <span x-text="new Date().toLocaleDateString('nl-NL', {day: 'numeric', month: 'long', year: 'numeric'})"></span>
                                    <div class="presenter-area"
                                         @dblclick="editingPresenterName = true"
                                         title="Dubbelklik om naam te wijzigen">
                                        <span x-show="!editingPresenterName && presenterName"
                                              x-text="presenterName"></span>
                                        <span x-show="!editingPresenterName && !presenterName"
                                              class="presenter-placeholder">[dubbelklik voor naam]</span>
                                        <input x-show="editingPresenterName"
                                               x-model="presenterName"
                                               @keydown.enter="savePresenterName()"
                                               @blur="savePresenterName()"
                                               @keydown.escape="editingPresenterName = false"
                                               x-ref="presenterInput"
                                               class="presenter-input"
                                               placeholder="Uw naam">
                                    </div>
                                    <span>Bureau Architectuur, BZK</span>
                                </div>
                            </div>
                        </div>
                        <!-- Slide 2: Nu -->
                        <div class="slide" x-show="currentSlide === 1" x-cloak>
                            <div class="slide-content content-slide centered-content">
                                <h2>Huidige Situatie</h2>
                                <p>Iedere organisatie</p>
                                <p>
                                    heeft een <strong>eigen interpretatie</strong> van de wet
                                </p>
                                <p>
                                    die landt in <strong>eigen software</strong>
                                </p>
                            </div>
                        </div>
                        <!-- Slide 3: Het probleem -->
                        <div class="slide" x-show="currentSlide === 2" x-cloak>
                            <div class="slide-content content-slide centered-content">
                                <h2>Het gevolg</h2>
                                <p>Geen overzicht</p>
                                <p>Onvoorspelbaar</p>
                                <p>Onbeheersbaar</p>
                            </div>
                        </div>
                        <!-- Slide 4: Wat als... -->
                        <div class="slide" x-show="currentSlide === 3" x-cloak>
                            <div class="slide-content content-slide centered-content">
                                <h2>Wat als</h2>
                                <p>
                                    We <strong>beginnen met de wet</strong>
                                </p>
                                <p>
                                    Deze <strong>machine uitvoerbaar</strong> maken
                                </p>
                                <p>
                                    <strong>Openbaar</strong> publiceren
                                </p>
                            </div>
                        </div>
                        <!-- Slide 5: Demo -->
                        <div class="slide" x-show="currentSlide === 4" x-cloak>
                            <div class="slide-content title-slide">
                                <h1>Demo RegelRecht</h1>
                                <div class="slide-disclaimers">
                                    <p>Proof of concept</p>
                                    <p>Compleet verhaal, geen eindproduct</p>
                                    <p>We maken beleid door te doen</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Laws Tab Content (Embedded) -->
                <div class="tab-content"
                     x-show="activeTab === 'laws'"
                     x-cloak
                     id="laws-content">
                    <div x-html="lawsContent"></div>
                </div>
                <!-- Features Tab Content (Embedded) -->
                <div class="tab-content"
                     x-show="activeTab === 'features'"
                     x-cloak
                     id="features-content">
                    <div x-html="featuresContent"></div>
                </div>
                <!-- Graph Analysis Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'graph'"
                     x-cloak>
                    <iframe src="/analysis/graph/?demo=true"
                            frameborder="0"
                            class="tab-iframe"
                            title="Graph Analysis"></iframe>
                </div>
                <!-- Burger.nl Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'burger'"
                     x-cloak>
                    <iframe src="/?demo=true"
                            frameborder="0"
                            class="tab-iframe"
                            title="Burger.nl"></iframe>
                </div>
                <!-- Zaaksysteem Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'zaaksysteem'"
                     x-cloak>
                    <iframe src="/admin/TOESLAGEN?demo=true"
                            frameborder="0"
                            class="tab-iframe"
                            title="Zaaksysteem"></iframe>
                </div>
                <!-- Simulatie Tab (IFrame) -->
                <div class="tab-content iframe-content"
                     x-show="activeTab === 'simulatie'"
                     x-cloak>
                    <iframe src="/simulation/?demo=true"
                            frameborder="0"
                            class="tab-iframe"
                            title="Simulatie"></iframe>
                </div>
                <!-- Temporary Tabs (IFrame) -->
                <template x-for="tab in temporaryTabs" :key="tab.id">
                    <div class="tab-content iframe-content"
                         x-show="activeTab === tab.id"
                         x-cloak>
                        <iframe :src="tab.url" frameborder="0" class="tab-iframe" :title="tab.name"></iframe>
                    </div>
                </template>
            </div>
            <!-- Menu Overlay (shown when menu is open) -->
            <div x-show="menuOpen"
                 x-cloak
                 @click="menuOpen = false"
                 class="menu-overlay"></div>
            <!-- Menu Dropdown (fixed position, over iframes) -->
            <div x-show="menuOpen"
                 x-cloak
                 @click.away="menuOpen = false"
                 class="menu-dropdown-fixed">
                <!-- Feature Flags Section -->
                <div class="menu-section-title">Feature Flags</div>
                <div id="demo-feature-flags">{% include "demo/partials/feature_flags.html" %}</div>
                <div class="menu-divider"></div>
                <!-- Fullscreen Toggle -->
                <button @click="toggleFullscreen(); menuOpen = false" class="menu-item">
                    <span x-show="!isFullscreen">‚õ∂ Volledig scherm</span>
                    <span x-show="isFullscreen">‚§ì Volledig scherm verlaten</span>
                </button>
                <!-- Dark Mode Toggle -->
                <button @click="toggleTheme(); menuOpen = false" class="menu-item">
                    <span x-show="theme === 'light'">üåô Donkere modus</span>
                    <span x-show="theme === 'dark'">‚òÄÔ∏è Lichte modus</span>
                </button>
                <!-- Admin -->
                <button @click="openTemporaryTab('Admin', '/admin/control?demo=true'); menuOpen = false"
                        class="menu-item">‚öôÔ∏è Admin</button>
                <div class="menu-divider"></div>
                <!-- Reset State -->
                <form hx-post="/admin/reset"
                      hx-trigger="submit"
                      hx-on::after-request="var btn = event.target.querySelector('button'); btn.disabled = true; btn.innerText = 'Bezig met resetten‚Ä¶'; setTimeout(() => window.location.reload(), 7000)"
                      class="menu-item-form">
                    <button type="submit" class="menu-item menu-item-danger">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="menu-item-icon"
                             viewBox="0 0 24 24">
                            <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                            <path d="M19.933 13.041a8 8 0 1 1-9.925-8.788c3.899-1 7.935 1.007 9.425 4.747" />
                            <path d="M20 4v5h-5" />
                            </g>
                        </svg>
                        Reset state
                    </button>
                </form>
                <div class="menu-divider"></div>
                <!-- Version info (bottom, dim) -->
                <div class="menu-version">v{{ version }}</div>
            </div>
        </div>
        <!-- JavaScript -->
        <script src="/static/js/demo.js"></script>
        <script>
        // Global variables for feature testing (needed by feature_viewer_partial.html)
        let currentFeaturePath = '';
        let currentRunId = null;
        let pollInterval = null;

        // Global functions for feature scenarios (called by onclick handlers in rendered HTML)
        function toggleScenario(element) {
            const scenario = element.closest('.gherkin-scenario');
            if (!scenario) return;

            scenario.classList.toggle('collapsed');
            const icon = element.querySelector('.collapse-icon');
            if (icon) {
                icon.textContent = scenario.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
            }
        }

        function expandAllScenarios() {
            document.querySelectorAll('.gherkin-scenario').forEach(scenario => {
                scenario.classList.remove('collapsed');
                const icon = scenario.querySelector('.collapse-icon');
                if (icon) icon.textContent = '‚ñº';
            });
        }

        function collapseAllScenarios() {
            document.querySelectorAll('.gherkin-scenario').forEach(scenario => {
                scenario.classList.add('collapsed');
                const icon = scenario.querySelector('.collapse-icon');
                if (icon) icon.textContent = '‚ñ∂';
            });
        }

        async function runScenario(scenarioIndex) {
            const outputContent = document.getElementById('output-content');
            outputContent.innerHTML = '<div class="output-running">Scenario wordt uitgevoerd...</div>';

            try {
                const response = await fetch('/demo/feature/run-scenario', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        feature_path: currentFeaturePath,
                        scenario_index: parseInt(scenarioIndex)
                    })
                });

                const data = await response.json();
                currentRunId = data.run_id;

                // Start polling for output
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(pollForOutput, 500);

            } catch (error) {
                outputContent.innerHTML = `<div class="output-error">Error: ${error.message}</div>`;
            }
        }

        function filterOutput(output) {
            if (!output) return '';

            const lines = output.split('\n');
            let startIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (/\.py:\d+/.test(lines[i])) {
                    console.log('Found start line at index', i, ':', lines[i]);
                    startIndex = i;
                    break;
                }
            }

            if (startIndex >= 0) {
                const filtered = lines.slice(startIndex).join('\n');
                console.log('Filtered output from line', startIndex, 'length:', filtered.length);
                return filtered;
            }

            console.log('No filter marker found, returning full output');
            return output;
        }

        function highlightTestOutput(text) {
            if (!text) return '';

            // Escape HTML first to prevent XSS
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };

            let highlighted = escapeHtml(text);

            // Highlight tree drawing characters (must come first to avoid conflicts)
            highlighted = highlighted.replace(/([‚ïë‚îÇ‚îú‚îÄ]+)/g, '<span class="output-tree">$1</span>');

            // Highlight service and law names (pattern: SERVICE: law_name)
            highlighted = highlighted.replace(/\b([A-Z_]{2,})(:\s+)(\w+)/g,
                '<span class="output-service">$1</span>$2<span class="output-law">$3</span>');

            // Highlight variables (e.g., $LEEFTIJD, $BSN)
            highlighted = highlighted.replace(/(\$[A-Z_]+)/g, '<span class="output-variable">$1</span>');

            // Highlight dates (YYYY-MM-DD format)
            highlighted = highlighted.replace(/(\d{4}-\d{2}-\d{2})/g, '<span class="output-value-date">$1</span>');

            // Highlight numbers (standalone)
            highlighted = highlighted.replace(/\b(\d+)\b/g, '<span class="output-value-number">$1</span>');

            // Highlight operation keywords
            highlighted = highlighted.replace(/\b(Evaluating|Resolving|Computing|Requirement met|NOT met|Could not resolve|Missing required|Cannot compute)\b/g,
                '<span class="output-operation">$1</span>');

            // Highlight requirement status
            highlighted = highlighted.replace(/\b(requirements met)\b/gi, '<span class="output-requirement-met">$1</span>');
            highlighted = highlighted.replace(/\b(requirements not met|NOT met)\b/gi, '<span class="output-requirement-not-met">$1</span>');

            return highlighted;
        }

        async function pollForOutput() {
            if (!currentRunId) return;

            try {
                const response = await fetch(`/demo/feature/run-status/${currentRunId}`);
                const data = await response.json();

                const outputContent = document.getElementById('output-content');
                const filteredOutput = filterOutput(data.output);
                const highlightedOutput = highlightTestOutput(filteredOutput);
                outputContent.innerHTML = `<pre class="output-text">${highlightedOutput}</pre>`;

                // Update status
                const statusEl = document.getElementById('scenario-status');
                if (data.status === 'completed') {
                    statusEl.textContent = '‚úÖ Geslaagd';
                    statusEl.className = 'scenario-status passed';
                    clearInterval(pollInterval);
                    // Scroll to top when test completes
                    outputContent.scrollTop = 0;
                } else if (data.status === 'failed') {
                    statusEl.textContent = '‚ùå Mislukt';
                    statusEl.className = 'scenario-status failed';
                    clearInterval(pollInterval);
                    // Scroll to top when test completes
                    outputContent.scrollTop = 0;
                } else {
                    statusEl.textContent = '‚è≥ Bezig...';
                    statusEl.className = 'scenario-status running';
                    // Auto-scroll to bottom while running
                    outputContent.scrollTop = outputContent.scrollHeight;
                }

            } catch (error) {
                console.error('Error polling output:', error);
                clearInterval(pollInterval);
            }
        }

        async function runAllScenarios() {
            const outputContent = document.getElementById('output-content');
            outputContent.innerHTML = '<div class="output-running">Alle scenario\'s worden uitgevoerd...</div>';

            try {
                const response = await fetch('/demo/run-feature', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        feature_path: currentFeaturePath
                    })
                });

                const data = await response.json();
                currentRunId = data.run_id;

                // Start polling for output
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(pollForOutput, 500);

            } catch (error) {
                outputContent.innerHTML = `<div class="output-error">Error: ${error.message}</div>`;
            }
        }

        function clearOutput() {
            document.getElementById('output-content').innerHTML =
                '<div class="output-placeholder">Voer een scenario uit om de output hier te zien...</div>';
            document.getElementById('scenario-status').textContent = '';
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function workspaceData() {
            return {
                activeTab: 'presentatie',
                lawsContent: '',
                featuresContent: '',
                lawsLoaded: false,
                featuresLoaded: false,
                isFullscreen: false,
                menuOpen: false,          // Hamburger menu state
                theme: localStorage.getItem('theme') || 'light',  // Theme: 'light' or 'dark'
                openedLawTabs: [],        // Array of {path: string, name: string, id: string}
                activeLawTabId: null,     // Currently active law tab ID
                nextLawTabId: 1,          // Auto-incrementing ID for law tabs
                maxLawTabs: 10,           // Maximum number of law tabs
                temporaryTabs: [],        // Array of {id: string, name: string, url: string}
                nextTempTabId: 1,         // Auto-incrementing ID for temporary tabs
                previousTab: null,        // Tab to return to when closing temporary tab
                // Presentation slide state
                currentSlide: 0,
                totalSlides: 5,
                presenterName: localStorage.getItem('presenterName') || '',
                editingPresenterName: false,

                init() {
                    // Initialize theme
                    document.documentElement.setAttribute('data-theme', this.theme);

                    // Load law tabs from localStorage
                    const savedLawTabs = localStorage.getItem('openedLawTabs');
                    if (savedLawTabs) {
                        try {
                            this.openedLawTabs = JSON.parse(savedLawTabs);
                            const savedActiveLawTabId = localStorage.getItem('activeLawTabId');
                            this.activeLawTabId = savedActiveLawTabId ||
                                                   (this.openedLawTabs.length > 0 ? this.openedLawTabs[0].id : null);

                            // Set nextLawTabId to highest existing ID + 1
                            if (this.openedLawTabs.length > 0) {
                                const maxId = Math.max(...this.openedLawTabs.map(t => parseInt(t.id.replace('law-tab-', ''))));
                                this.nextLawTabId = maxId + 1;
                            }
                        } catch (e) {
                            console.error('Error loading law tabs from localStorage:', e);
                            this.openedLawTabs = [];
                        }
                    }

                    // Check URL hash first
                    const hash = window.location.hash.substring(1);
                    const validTabs = ['presentatie', 'laws', 'features', 'graph', 'burger', 'zaaksysteem', 'simulatie'];

                    if (hash && validTabs.includes(hash)) {
                        this.activeTab = hash;
                    } else {
                        // Check localStorage
                        const savedTab = localStorage.getItem('activeTab');
                        if (savedTab && validTabs.includes(savedTab)) {
                            this.activeTab = savedTab;
                        }
                    }

                    // Load initial content for active tab
                    // If we have a saved active law tab and we're on the laws tab, load that law
                    if (this.activeTab === 'laws' && this.activeLawTabId && this.openedLawTabs.length > 0) {
                        const activeTab = this.openedLawTabs.find(t => t.id === this.activeLawTabId);
                        if (activeTab) {
                            this.loadTabContent('laws', `/demo/workspace/law/${activeTab.path}`);
                        } else {
                            this.loadTabContent(this.activeTab);
                        }
                    } else {
                        this.loadTabContent(this.activeTab);
                    }

                    // Listen for hash changes (browser back/forward)
                    window.addEventListener('hashchange', () => {
                        const newHash = window.location.hash.substring(1);
                        if (newHash && validTabs.includes(newHash)) {
                            this.activeTab = newHash;
                            this.loadTabContent(newHash);
                        }
                    });

                    // Listen for fullscreen changes (e.g., ESC key)
                    document.addEventListener('fullscreenchange', () => {
                        this.isFullscreen = !!document.fullscreenElement;
                    });

                    // Listen for keyboard events (prevent duplicate listeners)
                    if (!window._workspaceKeydownHandler) {
                        const self = this;
                        window._workspaceKeydownHandler = (e) => {
                            // Presentation slide navigation
                            if (self.activeTab === 'presentatie' && !self.editingPresenterName) {
                                if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'PageDown') {
                                    e.preventDefault();
                                    // If on last slide, navigate to Wetten tab
                                    if (self.currentSlide === self.totalSlides - 1) {
                                        self.switchTab('laws');
                                    } else {
                                        self.nextSlide();
                                    }
                                } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
                                    e.preventDefault();
                                    self.prevSlide();
                                } else if (e.key === 'Home') {
                                    e.preventDefault();
                                    self.goToSlide(0);
                                } else if (e.key === 'End') {
                                    e.preventDefault();
                                    self.goToSlide(self.totalSlides - 1);
                                }
                            }

                            // Ctrl-R / Cmd-R to refresh only the active iframe
                            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                                e.preventDefault(); // Prevent full page refresh

                                const iframeTabs = ['graph', 'burger', 'zaaksysteem', 'simulatie'];

                                if (iframeTabs.includes(self.activeTab)) {
                                    // Find and reload the active iframe
                                    const iframe = document.querySelector(`.iframe-content[x-show="activeTab === '${self.activeTab}'"] iframe`);
                                    if (iframe) {
                                        iframe.src = iframe.src; // Reload iframe
                                        console.log(`Refreshed iframe: ${self.activeTab}`);
                                    }
                                } else {
                                    // For embedded content tabs (laws, features), reload content
                                    self.loadTabContent(self.activeTab);
                                    console.log(`Refreshed content: ${self.activeTab}`);
                                }
                            }
                        };
                        document.addEventListener('keydown', window._workspaceKeydownHandler);
                    }

                    // Listen for postMessage from iframes when Ctrl-R is pressed inside them
                    window.addEventListener('message', (e) => {
                        if (e.origin === window.location.origin && e.data.type === 'refresh-iframe') {
                            const iframeTabs = ['graph', 'burger', 'zaaksysteem', 'simulatie'];

                            if (iframeTabs.includes(this.activeTab)) {
                                const iframe = document.querySelector(`.iframe-content[x-show="activeTab === '${this.activeTab}'"] iframe`);
                                if (iframe) {
                                    iframe.src = iframe.src; // Reload iframe
                                    console.log(`Refreshed iframe from inside: ${this.activeTab}`);
                                }
                            }
                        }
                    });
                },

                toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        // Enter fullscreen
                        const element = document.querySelector('.workspace-container');
                        if (element.requestFullscreen) {
                            element.requestFullscreen();
                        } else if (element.webkitRequestFullscreen) {
                            element.webkitRequestFullscreen(); // Safari
                        } else if (element.msRequestFullscreen) {
                            element.msRequestFullscreen(); // IE11
                        }
                        this.isFullscreen = true;
                    } else {
                        // Exit fullscreen
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen(); // Safari
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen(); // IE11
                        }
                        this.isFullscreen = false;
                    }
                },

                toggleTheme() {
                    // Toggle between light and dark mode
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', this.theme);
                    localStorage.setItem('theme', this.theme);
                    console.log('Theme switched to:', this.theme);
                },

                openTemporaryTab(name, url) {
                    // Check if tab with same URL already exists
                    const existingTab = this.temporaryTabs.find(t => t.url === url);
                    if (existingTab) {
                        // Switch to existing tab
                        this.activeTab = existingTab.id;
                        return;
                    }

                    // Store current tab to return to when closing
                    this.previousTab = this.activeTab;

                    // Create new temporary tab
                    const newTab = {
                        id: `temp-tab-${this.nextTempTabId++}`,
                        name: name,
                        url: url
                    };

                    this.temporaryTabs.push(newTab);
                    this.activeTab = newTab.id;

                    // Update URL hash
                    window.location.hash = newTab.id;
                },

                closeTemporaryTab(tabId) {
                    const tabIndex = this.temporaryTabs.findIndex(t => t.id === tabId);
                    if (tabIndex === -1) return;

                    // Remove the tab
                    this.temporaryTabs.splice(tabIndex, 1);

                    // If closing the active tab, switch back to previous or first fixed tab
                    if (this.activeTab === tabId) {
                        if (this.previousTab && this.previousTab !== tabId) {
                            this.switchTab(this.previousTab);
                        } else {
                            this.switchTab('presentatie');
                        }
                    }
                },

                // Presentation slide navigation
                nextSlide() {
                    if (this.currentSlide < this.totalSlides - 1) {
                        this.currentSlide++;
                    }
                },

                prevSlide() {
                    if (this.currentSlide > 0) {
                        this.currentSlide--;
                    }
                },

                goToSlide(n) {
                    if (n >= 0 && n < this.totalSlides) {
                        this.currentSlide = n;
                    }
                },

                savePresenterName() {
                    localStorage.setItem('presenterName', this.presenterName);
                    this.editingPresenterName = false;
                },

                switchTab(tab) {
                    this.activeTab = tab;

                    // Update URL hash
                    window.location.hash = tab;

                    // Save to localStorage
                    localStorage.setItem('activeTab', tab);

                    // Load content if needed
                    this.loadTabContent(tab);
                },

                async loadTabContent(tab, url = null) {
                    // Load laws content
                    if (tab === 'laws') {
                        if (!this.lawsLoaded || url) {
                            try {
                                const fetchUrl = url || '/demo/workspace/laws';
                                const response = await fetch(fetchUrl);

                                // Get the final URL after any redirects
                                const finalUrl = new URL(response.url).pathname;

                                this.lawsContent = await response.text();
                                this.lawsLoaded = true;

                                // If loading a specific law (final URL contains /law/), extract info and create/update tab
                                if (finalUrl.includes('/demo/workspace/law/')) {
                                    const lawPath = finalUrl.replace('/demo/workspace/law/', '');

                                    // Wait for content to render, then extract law name from the page
                                    this.$nextTick(() => {
                                        // Extract service and law ID from badges
                                        const badges = document.querySelectorAll('#laws-content .law-meta .badge');
                                        let service = '';
                                        let lawId = '';
                                        badges.forEach(badge => {
                                            const text = badge.textContent.trim();
                                            if (text && !text.startsWith('Geldig vanaf:')) {
                                                if (!service) {
                                                    service = text;
                                                } else if (!lawId) {
                                                    lawId = text;
                                                }
                                            }
                                        });

                                        // Use law ID as tab name, fallback to lawPath if not found
                                        const tabName = lawId || lawPath;

                                        // Check if tab already exists
                                        const existingTab = this.openedLawTabs.find(t => t.path === lawPath);
                                        if (!existingTab) {
                                            // Create new tab
                                            const newTab = {
                                                id: `law-tab-${this.nextLawTabId++}`,
                                                path: lawPath,
                                                name: tabName,
                                                law: lawId,
                                                service: service
                                            };
                                            this.openedLawTabs.push(newTab);
                                            this.activeLawTabId = newTab.id;
                                            this.saveLawTabsToStorage();
                                        } else {
                                            // Update existing tab name with fresh data (in case it was old/incorrect)
                                            existingTab.name = tabName;
                                            existingTab.law = lawId;
                                            existingTab.service = service;
                                            this.activeLawTabId = existingTab.id;
                                            this.saveLawTabsToStorage();
                                        }
                                    });
                                }

                                // After content loads, attach click handlers and init sidebar
                                this.$nextTick(() => {
                                    this.attachLawClickHandlers();
                                    this.initLawsSidebar();
                                });
                            } catch (error) {
                                console.error('Error loading laws content:', error);
                                this.lawsContent = '<div class="error-message">Error loading laws content</div>';
                            }
                        }
                    }

                    // Load features content
                    if (tab === 'features') {
                        if (!this.featuresLoaded || url) {
                            try {
                                const fetchUrl = url || '/demo/workspace/features';
                                const response = await fetch(fetchUrl);
                                this.featuresContent = await response.text();
                                this.featuresLoaded = true;

                                // Extract feature path from URL for global variable
                                if (url) {
                                    // URL format: /demo/workspace/feature/{feature_path}
                                    const match = url.match(/\/demo\/workspace\/feature\/(.+)/);
                                    if (match) {
                                        currentFeaturePath = match[1];
                                    }
                                } else {
                                    // Default feature path
                                    currentFeaturePath = 'features/TOESLAGEN-2025-01-01.feature';
                                }

                                // After content loads, attach click handlers and init sidebar
                                this.$nextTick(() => {
                                    this.attachFeatureClickHandlers();
                                    this.initFeaturesSidebar();
                                });
                            } catch (error) {
                                console.error('Error loading features content:', error);
                                this.featuresContent = '<div class="error-message">Error loading features content</div>';
                            }
                        }
                    }

                    // IFrame-based tabs load on demand automatically via x-show
                },

                initLawsSidebar() {
                    const sidebar = document.getElementById('laws-sidebar');
                    const collapsedToggle = document.getElementById('laws-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) {
                        console.warn('Laws sidebar elements not found');
                        return;
                    }

                    const savedState = localStorage.getItem('lawsSidebarCollapsed');
                    const isCollapsed = savedState === null ? true : savedState === 'true';

                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        collapsedToggle.style.display = 'block';
                        sidebarToggle.style.display = 'none';
                    } else {
                        sidebar.classList.remove('collapsed');
                        collapsedToggle.style.display = 'none';
                        sidebarToggle.style.display = 'block';
                    }

                    // Attach event listeners to toggle buttons
                    collapsedToggle.onclick = () => this.toggleLawsSidebar();
                    sidebarToggle.onclick = () => this.toggleLawsSidebar();
                },

                toggleLawsSidebar() {
                    const sidebar = document.getElementById('laws-sidebar');
                    const collapsedToggle = document.getElementById('laws-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) return;

                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');

                    collapsedToggle.style.display = isCollapsed ? 'block' : 'none';
                    sidebarToggle.style.display = isCollapsed ? 'none' : 'block';

                    localStorage.setItem('lawsSidebarCollapsed', isCollapsed);
                },

                initFeaturesSidebar() {
                    const sidebar = document.getElementById('features-sidebar');
                    const collapsedToggle = document.getElementById('features-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) {
                        console.warn('Features sidebar elements not found');
                        return;
                    }

                    const savedState = localStorage.getItem('featuresSidebarCollapsed');
                    const isCollapsed = savedState === null ? true : savedState === 'true';

                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        collapsedToggle.style.display = 'block';
                        sidebarToggle.style.display = 'none';
                    } else {
                        sidebar.classList.remove('collapsed');
                        collapsedToggle.style.display = 'none';
                        sidebarToggle.style.display = 'block';
                    }

                    // Attach event listeners to toggle buttons
                    collapsedToggle.onclick = () => this.toggleFeaturesSidebar();
                    sidebarToggle.onclick = () => this.toggleFeaturesSidebar();
                },

                toggleFeaturesSidebar() {
                    const sidebar = document.getElementById('features-sidebar');
                    const collapsedToggle = document.getElementById('features-sidebar-toggle-collapsed');
                    const sidebarToggle = sidebar?.querySelector('.sidebar-toggle');

                    if (!sidebar || !collapsedToggle || !sidebarToggle) return;

                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');

                    collapsedToggle.style.display = isCollapsed ? 'block' : 'none';
                    sidebarToggle.style.display = isCollapsed ? 'none' : 'block';

                    localStorage.setItem('featuresSidebarCollapsed', isCollapsed);
                },

                openLawTab(lawPath, lawName, lawId, service) {
                    // Check if law is already open
                    const existingTab = this.openedLawTabs.find(tab => tab.path === lawPath);
                    if (existingTab) {
                        // Switch to existing tab
                        this.switchLawTab(existingTab.id);
                        return;
                    }

                    // Check max tabs limit
                    if (this.openedLawTabs.length >= this.maxLawTabs) {
                        alert(`Maximum of ${this.maxLawTabs} law tabs can be open at once. Please close some tabs first.`);
                        return;
                    }

                    // Use law ID as tab name (e.g., "zorgtoeslagwet", "zvw"), fallback to lawName if not available
                    const tabName = lawId || lawName;

                    // Create new tab
                    const newTab = {
                        id: `law-tab-${this.nextLawTabId++}`,
                        path: lawPath,
                        name: tabName,
                        law: lawId,
                        service: service
                    };

                    this.openedLawTabs.push(newTab);
                    this.activeLawTabId = newTab.id;

                    // Save to localStorage
                    this.saveLawTabsToStorage();

                    // Load the law content
                    this.loadTabContent('laws', `/demo/workspace/law/${lawPath}`);
                },

                switchLawTab(tabId) {
                    const tab = this.openedLawTabs.find(t => t.id === tabId);
                    if (!tab) return;

                    this.activeLawTabId = tabId;
                    localStorage.setItem('activeLawTabId', tabId);

                    // Load the law content
                    this.loadTabContent('laws', `/demo/workspace/law/${tab.path}`);
                },

                closeLawTab(tabId) {
                    const tabIndex = this.openedLawTabs.findIndex(t => t.id === tabId);
                    if (tabIndex === -1) return;

                    // Remove the tab
                    this.openedLawTabs.splice(tabIndex, 1);

                    // If closing active tab, switch to another tab
                    if (this.activeLawTabId === tabId) {
                        if (this.openedLawTabs.length > 0) {
                            // Switch to previous tab, or first tab if we closed the first one
                            const newActiveIndex = Math.max(0, tabIndex - 1);
                            this.switchLawTab(this.openedLawTabs[newActiveIndex].id);
                        } else {
                            // No tabs left, load default view
                            this.activeLawTabId = null;
                            this.loadTabContent('laws');
                        }
                    }

                    // Save to localStorage
                    this.saveLawTabsToStorage();
                },

                closeAllLawTabs() {
                    if (!confirm('Close all law tabs?')) return;

                    this.openedLawTabs = [];
                    this.activeLawTabId = null;
                    this.saveLawTabsToStorage();

                    // Load default view
                    this.loadTabContent('laws');
                },

                saveLawTabsToStorage() {
                    localStorage.setItem('openedLawTabs', JSON.stringify(this.openedLawTabs));
                    if (this.activeLawTabId) {
                        localStorage.setItem('activeLawTabId', this.activeLawTabId);
                    } else {
                        localStorage.removeItem('activeLawTabId');
                    }
                },

                attachLawClickHandlers() {
                    // Intercept law links in sidebar
                    const lawLinks = document.querySelectorAll('#laws-content a[href^="/demo/law/"]');
                    lawLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            const lawPath = href.replace('/demo/law/', '');

                            // Extract metadata from link element
                            const lawName = link.querySelector('.law-name')?.textContent || lawPath;
                            const lawId = link.getAttribute('data-law') || '';
                            const service = link.getAttribute('data-service') || '';

                            // Open in new law tab
                            this.openLawTab(lawPath, lawName, lawId, service);
                        });
                    });

                    // Also intercept cross-reference links within law content
                    const crossRefLinks = document.querySelectorAll('#laws-content .cross-law-link');
                    crossRefLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            const lawPath = href.replace('/demo/law/', '');

                            // Extract name from link text or use path
                            const lawName = link.textContent.replace('‚Üí Ga naar ', '').trim() || lawPath;

                            // Open in new law tab (without service/law metadata for cross-refs)
                            this.openLawTab(lawPath, lawName, '', '');
                        });
                    });
                },

                attachFeatureClickHandlers() {
                    // Intercept feature links to load within tab
                    const featureLinks = document.querySelectorAll('#features-content a[href^="/demo/feature/"]');
                    featureLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const href = link.getAttribute('href');
                            this.loadTabContent('features', href.replace('/demo/feature/', '/demo/workspace/feature/'));
                        });
                    });
                }
            }
        }
        </script>
    </body>
</html>
