{% from "macros/logos.html" import org_logo %}
{# Geluidsontheffingspas tile - uses law evaluation output from source_type: "cases" #}
<div class="law-result-card min-h-64 bg-white rounded-lg shadow"
     x-data="{ showExplanation: false }"
     @close-explanation.window="showExplanation = false"
     id="tile-{{ law|replace('/', '-') }}">
    <div class="p-6 flex flex-col h-full">
        {# Get usage data from result or path (path is fallback when requirements fail) #}
        {% set max_count = 12 %}
        {% if result and result.aantal_verleende_ontheffingen_dit_jaar is defined %}
            {% set used = result.aantal_verleende_ontheffingen_dit_jaar %}
        {% elif path and path.VERLEENDE_ONTHEFFINGEN_DIT_JAAR is defined %}
            {% set used = path.VERLEENDE_ONTHEFFINGEN_DIT_JAAR.result|length|default(0) %}
        {% else %}
            {% set used = 0 %}
        {% endif %}
        {% set remaining = max_count - used %}
        <div class="flex-grow space-y-6">
            <!-- Header -->
            <div class="flex items-start justify-between border-b border-gray-100 pb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">{{ rule_spec.name }}</h3>
                    {% if current_case and not (current_case.status == 'DECIDED' and current_case.approved) %}
                        <div class="mt-2">{% include "partials/tiles/components/case_status_badge.html" %}</div>
                    {% endif %}
                </div>
                <div class="-mt-2 -mr-2">{{ org_logo(service) }}</div>
            </div>
            <!-- Main Content - Progress Bar -->
            <div class="space-y-6">
                {% include "partials/tiles/law/algemene_plaatselijke_verordening/ontheffingspas_geluid/GEMEENTE_ROTTERDAM/computation.html" %}
            </div>
            {# Rejection explanation when case was rejected #}
            {% if current_case and current_case.status == 'DECIDED' and current_case.approved == false %}
                <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}&default_tab=explanation"
                        hx-target="#shared-application-panel"
                        hx-swap="innerHTML"
                        class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                    waarom?
                </button>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-2">Mogelijkheid tot bezwaar</h4>
                    <p class="text-sm text-gray-600 mb-4">
                        U kunt binnen {{ current_case.objection_status.objection_period }} weken
                        bezwaar maken tegen dit besluit.
                    </p>
                    <button type="button"
                            onclick="showAppealDialog('{{ current_case.id }}')"
                            class="w-full px-4 py-2 bg-red-600 text-white text-center rounded-md hover:bg-red-700 transition-colors cursor-pointer">
                        Ga in bezwaar
                    </button>
                </div>
            {% endif %}
        </div>
        <!-- Actions Section -->
        <div class="mt-6 pt-4 border-t border-gray-100">
            {% if current_case and current_case.status == 'DECIDED' and current_case.approved == false %}
                {# Rejected case - show option to try again #}
                <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}{% if kvk %}&kvk={{ kvk }}{% endif %}&default_tab=application"
                        hx-target="#shared-application-panel"
                        hx-swap="innerHTML"
                        class="w-full px-6 py-3 bg-gray-600 text-white text-center rounded-md hover:bg-gray-700 transition-colors cursor-pointer">
                    Nieuwe aanvraag indienen
                </button>
            {% elif current_case and current_case.status == 'DECIDED' and current_case.approved == true %}
                {# Approved case - show success message #}
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center mb-4">
                    <p class="text-sm text-green-800">
                        Uw geluidsontheffing voor {{ current_case.parameters.ACTIVITEITSDATUM|default(current_case.claimed_result.ACTIVITEITSDATUM, true) |default('de aangevraagde datum', true) }} is goedgekeurd.
                    </p>
                </div>
                <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}{% if kvk %}&kvk={{ kvk }}{% endif %}&default_tab=application"
                        hx-target="#shared-application-panel"
                        hx-swap="innerHTML"
                        class="w-full px-6 py-3 bg-gray-600 text-white text-center rounded-md hover:bg-gray-700 transition-colors cursor-pointer">
                    Nieuwe aanvraag indienen
                </button>
            {% elif current_case and current_case.status == 'SUBMITTED' %}
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                    <p class="text-sm text-blue-800">
                        Uw aanvraag wordt beoordeeld. Heeft u vragen? <a href="#" class="underline">Klik hier</a>, of bel 1234.
                    </p>
                </div>
            {% elif current_case and current_case.status == 'IN_REVIEW' %}
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900 mb-3">Wat gebeurt er nu?</h4>
                    <ol class="space-y-2 text-sm text-blue-800">
                        <li class="flex items-start">
                            <span class="font-medium mr-2">1.</span>
                            <span>Een medewerker bekijkt uw aanvraag binnen 5 werkdagen</span>
                        </li>
                        <li class="flex items-start">
                            <span class="font-medium mr-2">2.</span>
                            <span>U krijgt mogelijk een uitnodiging voor een gesprek</span>
                        </li>
                        <li class="flex items-start">
                            <span class="font-medium mr-2">3.</span>
                            <span>Binnen 6 weken ontvangt u bericht over uw aanvraag</span>
                        </li>
                    </ol>
                    <p class="mt-3 text-sm text-blue-800">
                        Heeft u vragen? <a href="#" class="underline">Klik hier</a>, of bel 1234.
                    </p>
                </div>
            {% elif remaining > 0 %}
                <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}{% if kvk %}&kvk={{ kvk }}{% endif %}&default_tab=application"
                        hx-target="#shared-application-panel"
                        hx-swap="innerHTML"
                        class="w-full px-6 py-3 bg-green-600 text-white text-center rounded-md hover:bg-green-700 transition-colors cursor-pointer">
                    Geluidsontheffing aanvragen
                </button>
            {% else %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <p class="text-sm text-yellow-800">U heeft het maximum aantal geluidsontheffingen voor dit jaar bereikt.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    // Listen for the close-panel event and close the shared panel
    document.addEventListener('close-panel', function() {
        const panel = document.getElementById('shared-application-panel');
        if (panel) {
            panel.innerHTML = '';
        }
    });
</script>
