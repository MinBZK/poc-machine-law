<div>
    {# Check profile_data for existing vergunning status - using namespace for Jinja2 loop scoping #}
    {% set ns = namespace(vergunning_info=none) %}
    {% if profile_data and profile_data.vergunningen %}
        {% for v in profile_data.vergunningen %}
            {% if v.kvk_nummer == kvk and v.heeft_exploitatievergunning %}
                {% set ns.vergunning_info = v %}
            {% endif %}
        {% endfor %}
    {% endif %}

    <h4 class="text-sm font-medium text-gray-600 mb-2">Uw exploitatievergunning is</h4>
    {% if ns.vergunning_info %}
        {# Vergunning is already granted - show status from profile data #}
        <div class="flex items-baseline">
            <span class="text-4xl font-bold text-green-600">Verleend</span>
            <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                Actief
            </span>
            <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}&default_tab=explanation"
                    hx-target="#shared-application-panel"
                    hx-swap="innerHTML"
                    class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                waarom?
            </button>
        </div>
    {% elif requirements_met or result.heeft_recht_op_vergunning %}
        <div class="flex items-baseline">
            <span class="text-2xl font-semibold text-blue-600">U komt in aanmerking</span>
            <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}&default_tab=explanation"
                    hx-target="#shared-application-panel"
                    hx-swap="innerHTML"
                    class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                waarom?
            </button>
        </div>
    {% else %}
        <div class="flex items-baseline">
            <span class="text-xl font-medium text-red-600">Niet toegekend</span>
            <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}&default_tab=explanation"
                    hx-target="#shared-application-panel"
                    hx-swap="innerHTML"
                    class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                waarom?
            </button>
        </div>
        {% if result.weigeringsgrond %}
            <p class="text-sm text-gray-600 mt-2">Reden: {{ result.weigeringsgrond }}</p>
        {% endif %}
    {% endif %}
</div>
