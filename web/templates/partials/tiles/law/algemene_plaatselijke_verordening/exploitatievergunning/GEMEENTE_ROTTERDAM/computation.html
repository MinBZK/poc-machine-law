<div>
    {# Check profile_data for existing vergunning status - using namespace for Jinja2 loop scoping #}
    {% set ns = namespace(vergunning_info=none) %}
    {% if profile_data and profile_data.vergunningen %}
        {% for v in profile_data.vergunningen %}
            {% if v.kvk_nummer == kvk and v.heeft_exploitatievergunning %}
                {% set ns.vergunning_info = v %}
            {% endif %}
        {% endfor %}
    {% endif %}
    {# Get category: prefer profile data (existing vergunning) over calculated result #}
    {% set categorie = ns.vergunning_info.vergunde_categorie if ns.vergunning_info and ns.vergunning_info.vergunde_categorie else result.vergunde_categorie %}
    <div class="text-sm text-gray-600 mb-2">
        <span class="font-medium">Uw exploitatievergunning voor</span>
        {% if categorie %}<span class="font-bold">{{ categorie }}</span>{% endif %}
        <span class="font-medium">is</span>
    </div>
    {% if ns.vergunning_info %}
        {# Vergunning is already granted - show status from profile data #}
        <div class="flex items-baseline">
            <span class="text-4xl font-bold text-green-600">Verleend</span>
            <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}{% if kvk %}&kvk={{ kvk }}{% endif %}&default_tab=explanation"
                    hx-target="#shared-application-panel"
                    hx-swap="innerHTML"
                    class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                waarom?
            </button>
        </div>
        {% if ns.vergunning_info.type_horeca %}
            <div class="mt-3 text-sm text-gray-600">
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400"
                         fill="none"
                         stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <span>openingstijden:
                        {% if ns.vergunning_info.openingstijden %}
                            <strong>{{ ns.vergunning_info.openingstijden }}</strong>
                        {% else %}
                            <strong>{{ ns.vergunning_info.openingstijden_doordeweeks }}</strong> (zo-do)
                            {% if ns.vergunning_info.openingstijden_weekend %}
                                / <strong>{{ ns.vergunning_info.openingstijden_weekend }}</strong> (vr-za)
                            {% endif %}
                        {% endif %}
                    </span>
                </div>
            </div>
        {% endif %}
    {% elif requirements_met or result.heeft_recht_op_vergunning %}
        <div class="flex items-baseline">
            <span class="text-2xl font-semibold text-blue-600">U komt in aanmerking</span>
            <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}{% if kvk %}&kvk={{ kvk }}{% endif %}&default_tab=explanation"
                    hx-target="#shared-application-panel"
                    hx-swap="innerHTML"
                    class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                waarom?
            </button>
        </div>
    {% else %}
        <div class="flex items-baseline">
            <span class="text-xl font-medium text-red-600">Niet toegekend</span>
            <button hx-get="/laws/application-panel?service={{ service }}&law={{ law|urlencode }}&bsn={{ effective_bsn|default(bsn) }}{% if kvk %}&kvk={{ kvk }}{% endif %}&default_tab=explanation"
                    hx-target="#shared-application-panel"
                    hx-swap="innerHTML"
                    class="ml-4 text-sm text-gray-400 hover:text-gray-900 border-b border-dotted border-gray-300 hover:border-gray-600 cursor-pointer">
                waarom?
            </button>
        </div>
        {% if result.weigeringsgrond %}
            <p class="text-sm text-gray-600 mt-2">Reden: {{ result.weigeringsgrond }}</p>
        {% endif %}
    {% endif %}
</div>
