<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="https://www.omg.org/spec/DMN/20191111/MODEL/"
             xmlns:dmndi="https://www.omg.org/spec/DMN/20191111/DMNDI/"
             xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/"
             xmlns:di="http://www.omg.org/spec/DMN/20180521/DI/"
             xmlns:feel="https://www.omg.org/spec/DMN/20191111/FEEL/"
             id="zorgtoeslag_toeslagen_2025"
             name="Zorgtoeslag 2025 (Toeslagen)"
             namespace="https://regels.overheid.nl/zorgtoeslagwet/TOESLAGEN-2025-01-01"
             exporter="Claude Code"
             exporterVersion="1.0">

  <!-- Import Dependencies -->
  <import namespace="https://regels.overheid.nl/standaardpremie/VWS-2025-01-01"
          locationURI="standaardpremie_2025.dmn"
          importType="https://www.omg.org/spec/DMN/20191111/MODEL/"/>
  <import namespace="https://regels.overheid.nl/wet_brp/RVIG-2020-01-01"
          locationURI="wet_brp_rvig.dmn"
          importType="https://www.omg.org/spec/DMN/20191111/MODEL/"/>
  <import namespace="https://regels.overheid.nl/zvw/RVZ-2024-01-01"
          locationURI="zvw_rvz.dmn"
          importType="https://www.omg.org/spec/DMN/20191111/MODEL/"/>
  <import namespace="https://regels.overheid.nl/wet_inkomstenbelasting/BELASTINGDIENST-2025-01-01"
          locationURI="wet_inkomstenbelasting_belastingdienst.dmn"
          importType="https://www.omg.org/spec/DMN/20191111/MODEL/"/>
  <import namespace="https://regels.overheid.nl/wet_inkomstenbelasting/UWV-2025-01-01"
          locationURI="wet_inkomstenbelasting_uwv.dmn"
          importType="https://www.omg.org/spec/DMN/20191111/MODEL/"/>

  <!-- Input Data -->
  <inputData id="input_person" name="Person">
    <variable name="person" typeRef="context"/>
  </inputData>

  <inputData id="input_reference_date" name="Reference Date">
    <variable name="reference_date" typeRef="date"/>
  </inputData>

  <inputData id="input_tax_data" name="Tax Data">
    <variable name="tax_data" typeRef="context"/>
  </inputData>

  <inputData id="input_income_data" name="Income Data">
    <variable name="income_data" typeRef="context"/>
  </inputData>

  <inputData id="input_partner_income_data" name="Partner Income Data">
    <variable name="partner_income_data" typeRef="context"/>
  </inputData>

  <!-- Constants -->
  <businessKnowledgeModel id="bkm_constants" name="Zorgtoeslag Constants">
    <variable name="constants" typeRef="context"/>
    <encapsulatedLogic>
      <literalExpression>
        <text>{
          MINIMUM_LEEFTIJD: 18,
          PERCENTAGE_DREMPELINKOMEN_MET_PARTNER: 0.04273,
          PERCENTAGE_DREMPELINKOMEN_ALLEENSTAAND: 0.01896,
          AFBOUWPERCENTAGE_MINIMUM: 0.13700,
          DREMPELINKOMEN_ALLEENSTAANDE: 3971900,
          DREMPELINKOMEN_TOESLAGPARTNER: 5020600,
          VERMOGENSGRENS_ALLEENSTAANDE: 14189600,
          VERMOGENSGRENS_TOESLAGPARTNER: 17942900
        }</text>
      </literalExpression>
    </encapsulatedLogic>
  </businessKnowledgeModel>

  <!-- External Decision: Standaardpremie -->
  <decision id="decision_standaardpremie" name="Standaardpremie">
    <variable name="standaardpremie" typeRef="number"/>
    <literalExpression>
      <text>decisionService_standaardpremie()</text>
    </literalExpression>
  </decision>

  <!-- External Decision: Leeftijd -->
  <decision id="decision_leeftijd" name="Leeftijd">
    <variable name="leeftijd" typeRef="number"/>
    <informationRequirement>
      <requiredInput href="#input_person"/>
    </informationRequirement>
    <informationRequirement>
      <requiredInput href="#input_reference_date"/>
    </informationRequirement>
    <literalExpression>
      <text>decisionService_brp(person, reference_date).leeftijd</text>
    </literalExpression>
  </decision>

  <!-- External Decision: Heeft Toeslagpartner -->
  <decision id="decision_heeft_partner" name="Heeft Toeslagpartner">
    <variable name="heeft_partner" typeRef="boolean"/>
    <informationRequirement>
      <requiredInput href="#input_person"/>
    </informationRequirement>
    <informationRequirement>
      <requiredInput href="#input_reference_date"/>
    </informationRequirement>
    <literalExpression>
      <text>decisionService_brp(person, reference_date).heeft_toeslagpartner</text>
    </literalExpression>
  </decision>

  <!-- External Decision: Verzekerd voor ZVW -->
  <decision id="decision_is_verzekerde" name="Is Verzekerde">
    <variable name="is_verzekerde" typeRef="boolean"/>
    <informationRequirement>
      <requiredInput href="#input_person"/>
    </informationRequirement>
    <literalExpression>
      <text>decisionService_zvw(person)</text>
    </literalExpression>
  </decision>

  <!-- External Decision: Toetsingsinkomen -->
  <decision id="decision_toetsingsinkomen" name="Toetsingsinkomen">
    <variable name="toetsingsinkomen" typeRef="number"/>
    <informationRequirement>
      <requiredInput href="#input_income_data"/>
    </informationRequirement>
    <literalExpression>
      <text>decisionService_uwv(person, income_data)</text>
    </literalExpression>
  </decision>

  <!-- External Decision: Partner Toetsingsinkomen -->
  <decision id="decision_partner_toetsingsinkomen" name="Partner Toetsingsinkomen">
    <variable name="partner_toetsingsinkomen" typeRef="number"/>
    <informationRequirement>
      <requiredInput href="#input_partner_income_data"/>
    </informationRequirement>
    <literalExpression>
      <text>if partner_income_data != null then decisionService_uwv(person, partner_income_data) else 0</text>
    </literalExpression>
  </decision>

  <!-- External Decision: Vermogen -->
  <decision id="decision_vermogen" name="Vermogen">
    <variable name="vermogen" typeRef="number"/>
    <informationRequirement>
      <requiredInput href="#input_tax_data"/>
    </informationRequirement>
    <literalExpression>
      <text>decisionService_belastingdienst(person, tax_data).vermogen</text>
    </literalExpression>
  </decision>

  <!-- Business Knowledge Model: Calculate Normpremie for Singles -->
  <businessKnowledgeModel id="bkm_normpremie_single" name="Calculate Normpremie Single">
    <variable name="normpremie_single" typeRef="number"/>
    <encapsulatedLogic>
      <formalParameter name="inkomen" typeRef="number"/>
      <formalParameter name="drempelinkomen" typeRef="number"/>
      <formalParameter name="percentage_drempel" typeRef="number"/>
      <formalParameter name="afbouwpercentage" typeRef="number"/>
      <literalExpression>
        <text>if inkomen > drempelinkomen then percentage_drempel * drempelinkomen + afbouwpercentage * (inkomen - drempelinkomen) else percentage_drempel * inkomen</text>
      </literalExpression>
    </encapsulatedLogic>
  </businessKnowledgeModel>

  <!-- Business Knowledge Model: Calculate Normpremie for Partners -->
  <businessKnowledgeModel id="bkm_normpremie_partner" name="Calculate Normpremie Partner">
    <variable name="normpremie_partner" typeRef="number"/>
    <encapsulatedLogic>
      <formalParameter name="inkomen" typeRef="number"/>
      <formalParameter name="partner_inkomen" typeRef="number"/>
      <formalParameter name="drempelinkomen" typeRef="number"/>
      <formalParameter name="percentage_drempel" typeRef="number"/>
      <formalParameter name="afbouwpercentage" typeRef="number"/>
      <literalExpression>
        <text>if inkomen + partner_inkomen > drempelinkomen then percentage_drempel * drempelinkomen + afbouwpercentage * (inkomen + partner_inkomen - drempelinkomen) else percentage_drempel * (inkomen + partner_inkomen)</text>
      </literalExpression>
    </encapsulatedLogic>
  </businessKnowledgeModel>

  <!-- Decision: Eligibility Check -->
  <decision id="decision_is_verzekerde_zorgtoeslag" name="Is Verzekerde Zorgtoeslag">
    <variable name="is_verzekerde_zorgtoeslag" typeRef="boolean"/>
    <informationRequirement>
      <requiredDecision href="#decision_leeftijd"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_is_verzekerde"/>
    </informationRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_constants"/>
    </knowledgeRequirement>
    <literalExpression>
      <text>leeftijd >= constants().MINIMUM_LEEFTIJD and is_verzekerde = true</text>
    </literalExpression>
  </decision>

  <!-- REFACTORED INTERMEDIATE DECISIONS -->

  <!-- Intermediate Decision: Gezamenlijk Inkomen -->
  <decision id="decision_gezamenlijk_inkomen" name="Gezamenlijk Inkomen">
    <description>Calculate combined income for partners, or just individual income for singles</description>
    <variable name="gezamenlijk_inkomen" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_heeft_partner"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_toetsingsinkomen"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_partner_toetsingsinkomen"/>
    </informationRequirement>
    <literalExpression>
      <text>if heeft_partner then toetsingsinkomen + partner_toetsingsinkomen else toetsingsinkomen</text>
    </literalExpression>
  </decision>

  <!-- Intermediate Decision: Applicable Drempelinkomen -->
  <decision id="decision_applicable_drempelinkomen" name="Applicable Drempelinkomen">
    <description>Determine which income threshold applies based on partner status</description>
    <variable name="applicable_drempelinkomen" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_heeft_partner"/>
    </informationRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_constants"/>
    </knowledgeRequirement>
    <literalExpression>
      <text>if heeft_partner then constants().DREMPELINKOMEN_TOESLAGPARTNER else constants().DREMPELINKOMEN_ALLEENSTAANDE</text>
    </literalExpression>
  </decision>

  <!-- Intermediate Decision: Applicable Vermogensgrens -->
  <decision id="decision_applicable_vermogensgrens" name="Applicable Vermogensgrens">
    <description>Determine which wealth limit applies based on partner status</description>
    <variable name="applicable_vermogensgrens" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_heeft_partner"/>
    </informationRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_constants"/>
    </knowledgeRequirement>
    <literalExpression>
      <text>if heeft_partner then constants().VERMOGENSGRENS_TOESLAGPARTNER else constants().VERMOGENSGRENS_ALLEENSTAANDE</text>
    </literalExpression>
  </decision>

  <!-- Intermediate Decision: Inkomen Overschreden -->
  <decision id="decision_inkomen_overschreden" name="Inkomen Overschreden">
    <description>Check if income exceeds the applicable threshold</description>
    <variable name="inkomen_overschreden" typeRef="boolean"/>
    <informationRequirement>
      <requiredDecision href="#decision_gezamenlijk_inkomen"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_applicable_drempelinkomen"/>
    </informationRequirement>
    <literalExpression>
      <text>gezamenlijk_inkomen > applicable_drempelinkomen</text>
    </literalExpression>
  </decision>

  <!-- Intermediate Decision: Vermogen Overschreden -->
  <decision id="decision_vermogen_overschreden" name="Vermogen Overschreden">
    <description>Check if wealth exceeds the applicable limit</description>
    <variable name="vermogen_overschreden" typeRef="boolean"/>
    <informationRequirement>
      <requiredDecision href="#decision_vermogen"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_applicable_vermogensgrens"/>
    </informationRequirement>
    <literalExpression>
      <text>vermogen > applicable_vermogensgrens</text>
    </literalExpression>
  </decision>

  <!-- Decision Table: Eligibility Scenario -->
  <decision id="decision_eligibility_scenario" name="Eligibility Scenario">
    <description>Determine which eligibility scenario applies based on checks</description>
    <variable name="eligibility_scenario" typeRef="string"/>
    <informationRequirement>
      <requiredDecision href="#decision_is_verzekerde_zorgtoeslag"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_heeft_partner"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_inkomen_overschreden"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_vermogen_overschreden"/>
    </informationRequirement>
    <decisionTable id="table_eligibility_scenario" hitPolicy="UNIQUE">
      <input id="input_verzekerd" label="Is Verzekerde">
        <inputExpression typeRef="boolean">
          <text>is_verzekerde_zorgtoeslag</text>
        </inputExpression>
      </input>
      <input id="input_inkomen_check" label="Inkomen Overschreden">
        <inputExpression typeRef="boolean">
          <text>inkomen_overschreden</text>
        </inputExpression>
      </input>
      <input id="input_vermogen_check" label="Vermogen Overschreden">
        <inputExpression typeRef="boolean">
          <text>vermogen_overschreden</text>
        </inputExpression>
      </input>
      <input id="input_partner_check" label="Heeft Partner">
        <inputExpression typeRef="boolean">
          <text>heeft_partner</text>
        </inputExpression>
      </input>
      <output id="output_scenario" label="Eligibility Scenario" typeRef="string"/>
      <rule id="rule_not_eligible">
        <inputEntry><text>false</text></inputEntry>
        <inputEntry><text>-</text></inputEntry>
        <inputEntry><text>-</text></inputEntry>
        <inputEntry><text>-</text></inputEntry>
        <outputEntry><text>"not_eligible"</text></outputEntry>
      </rule>
      <rule id="rule_income_too_high">
        <inputEntry><text>true</text></inputEntry>
        <inputEntry><text>true</text></inputEntry>
        <inputEntry><text>-</text></inputEntry>
        <inputEntry><text>-</text></inputEntry>
        <outputEntry><text>"income_too_high"</text></outputEntry>
      </rule>
      <rule id="rule_assets_too_high">
        <inputEntry><text>true</text></inputEntry>
        <inputEntry><text>false</text></inputEntry>
        <inputEntry><text>true</text></inputEntry>
        <inputEntry><text>-</text></inputEntry>
        <outputEntry><text>"assets_too_high"</text></outputEntry>
      </rule>
      <rule id="rule_eligible_single">
        <inputEntry><text>true</text></inputEntry>
        <inputEntry><text>false</text></inputEntry>
        <inputEntry><text>false</text></inputEntry>
        <inputEntry><text>false</text></inputEntry>
        <outputEntry><text>"eligible_single"</text></outputEntry>
      </rule>
      <rule id="rule_eligible_partner">
        <inputEntry><text>true</text></inputEntry>
        <inputEntry><text>false</text></inputEntry>
        <inputEntry><text>false</text></inputEntry>
        <inputEntry><text>true</text></inputEntry>
        <outputEntry><text>"eligible_partner"</text></outputEntry>
      </rule>
    </decisionTable>
  </decision>

  <!-- Decision: Benefit Calculation Single -->
  <decision id="decision_benefit_calculation_single" name="Benefit Calculation Single">
    <description>Calculate benefit for single person (alleenstaand)</description>
    <variable name="benefit_calculation_single" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_standaardpremie"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_toetsingsinkomen"/>
    </informationRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_constants"/>
    </knowledgeRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_normpremie_single"/>
    </knowledgeRequirement>
    <literalExpression>
      <text>standaardpremie - normpremie_single(toetsingsinkomen, constants().DREMPELINKOMEN_ALLEENSTAANDE, constants().PERCENTAGE_DREMPELINKOMEN_ALLEENSTAAND, constants().AFBOUWPERCENTAGE_MINIMUM)</text>
    </literalExpression>
  </decision>

  <!-- Decision: Benefit Calculation Partner -->
  <decision id="decision_benefit_calculation_partner" name="Benefit Calculation Partner">
    <description>Calculate benefit for person with partner (toeslagpartner)</description>
    <variable name="benefit_calculation_partner" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_standaardpremie"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_toetsingsinkomen"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_partner_toetsingsinkomen"/>
    </informationRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_constants"/>
    </knowledgeRequirement>
    <knowledgeRequirement>
      <requiredKnowledge href="#bkm_normpremie_partner"/>
    </knowledgeRequirement>
    <literalExpression>
      <text>(2 * standaardpremie) - normpremie_partner(toetsingsinkomen, partner_toetsingsinkomen, constants().DREMPELINKOMEN_TOESLAGPARTNER, constants().PERCENTAGE_DREMPELINKOMEN_MET_PARTNER, constants().AFBOUWPERCENTAGE_MINIMUM)</text>
    </literalExpression>
  </decision>

  <!-- Decision: Final Benefit Calculation -->
  <decision id="decision_benefit_calculation" name="Benefit Calculation">
    <description>Select the appropriate benefit calculation based on eligibility scenario</description>
    <variable name="benefit_calculation" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_eligibility_scenario"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_benefit_calculation_single"/>
    </informationRequirement>
    <informationRequirement>
      <requiredDecision href="#decision_benefit_calculation_partner"/>
    </informationRequirement>
    <literalExpression>
      <text>if eligibility_scenario = "eligible_single" then benefit_calculation_single else if eligibility_scenario = "eligible_partner" then benefit_calculation_partner else 0</text>
    </literalExpression>
  </decision>

  <!-- Decision: Hoogte Toeslag (Refactored) -->
  <decision id="decision_hoogte_toeslag" name="Hoogte Toeslag">
    <description>Calculate healthcare benefit amount. Refactored from complex nested logic into decision table and intermediate decisions for better readability and maintainability.</description>
    <variable name="hoogte_toeslag" typeRef="number"/>
    <informationRequirement>
      <requiredDecision href="#decision_benefit_calculation"/>
    </informationRequirement>
    <literalExpression>
      <!--
        ORIGINAL COMPLEX LOGIC (Kept for reference):
        if is_verzekerde_zorgtoeslag = false then 0
        else if heeft_partner = false then
          if toetsingsinkomen > constants().DREMPELINKOMEN_ALLEENSTAANDE then 0
          else if vermogen > constants().VERMOGENSGRENS_ALLEENSTAANDE then 0
          else let normpremie = normpremie_single(toetsingsinkomen, constants().DREMPELINKOMEN_ALLEENSTAANDE, constants().PERCENTAGE_DREMPELINKOMEN_ALLEENSTAAND, constants().AFBOUWPERCENTAGE_MINIMUM) in standaardpremie - normpremie
        else let gezamenlijk_inkomen = toetsingsinkomen + partner_toetsingsinkomen in
          if gezamenlijk_inkomen > constants().DREMPELINKOMEN_TOESLAGPARTNER then 0
          else if vermogen > constants().VERMOGENSGRENS_TOESLAGPARTNER then 0
          else let normpremie = normpremie_partner(toetsingsinkomen, partner_toetsingsinkomen, constants().DREMPELINKOMEN_TOESLAGPARTNER, constants().PERCENTAGE_DREMPELINKOMEN_MET_PARTNER, constants().AFBOUWPERCENTAGE_MINIMUM) in (2 * standaardpremie) - normpremie

        NOW REFACTORED INTO:
        - decision_gezamenlijk_inkomen: Calculate combined income
        - decision_applicable_drempelinkomen: Determine income threshold
        - decision_applicable_vermogensgrens: Determine wealth limit
        - decision_inkomen_overschreden: Check income threshold
        - decision_vermogen_overschreden: Check wealth limit
        - decision_eligibility_scenario: Decision table for eligibility path
        - decision_benefit_calculation: Calculate final amount
      -->
      <text>benefit_calculation</text>
    </literalExpression>
  </decision>

  <!-- Decision Service -->
  <decisionService id="decisionService_zorgtoeslag" name="Zorgtoeslag Decision Service">
    <outputDecision href="#decision_is_verzekerde_zorgtoeslag"/>
    <outputDecision href="#decision_hoogte_toeslag"/>
    <inputData href="#input_person"/>
    <inputData href="#input_reference_date"/>
    <inputData href="#input_tax_data"/>
    <inputData href="#input_income_data"/>
    <inputData href="#input_partner_income_data"/>
  </decisionService>

  <!-- Diagram -->
  <dmndi:DMNDI>
    <dmndi:DMNDiagram id="diagram_zorgtoeslag">
      <dmndi:DMNShape id="shape_input_person" dmnElementRef="input_person">
        <dc:Bounds x="100" y="600" width="150" height="60"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_input_reference_date" dmnElementRef="input_reference_date">
        <dc:Bounds x="300" y="600" width="150" height="60"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_input_tax_data" dmnElementRef="input_tax_data">
        <dc:Bounds x="500" y="600" width="150" height="60"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_input_income_data" dmnElementRef="input_income_data">
        <dc:Bounds x="700" y="600" width="150" height="60"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_decision_leeftijd" dmnElementRef="decision_leeftijd">
        <dc:Bounds x="100" y="450" width="180" height="80"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_decision_heeft_partner" dmnElementRef="decision_heeft_partner">
        <dc:Bounds x="300" y="450" width="180" height="80"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_decision_is_verzekerde" dmnElementRef="decision_is_verzekerde">
        <dc:Bounds x="100" y="300" width="180" height="80"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_decision_eligibility" dmnElementRef="decision_is_verzekerde_zorgtoeslag">
        <dc:Bounds x="100" y="150" width="180" height="80"/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="shape_decision_hoogte" dmnElementRef="decision_hoogte_toeslag">
        <dc:Bounds x="400" y="50" width="180" height="80"/>
      </dmndi:DMNShape>
    </dmndi:DMNDiagram>
  </dmndi:DMNDI>

</definitions>
