<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>Chatbot met MCP</title>
    <style>
      /* Basic styling for markdown elements inside .message-content */
      .message-content h1 {
        font-size: 1.875rem;
        font-weight: bold;
        margin-bottom: 0.75rem;
        margin-top: 0.75rem;
      }

      .message-content h2 {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        margin-top: 0.5rem;
      }

      .message-content h3 {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        margin-top: 0.5rem;
      }

      .message-content h4 {
        font-size: 1.125rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
        margin-top: 0.25rem;
      }

      .message-content p:not(:last-child) {
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }

      .message-content a {
        color: #3b82f6;
        text-decoration: underline;
      }

      .message-content strong {
        font-weight: bold;
      }

      .message-content em {
        font-style: italic;
      }

      .message-content ul {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-bottom: 0.75rem;
      }

      .message-content ol {
        list-style-type: decimal;
        padding-left: 1.5rem;
        margin-bottom: 0.75rem;
      }

      .message-content li {
        margin-bottom: 0.25rem;
        line-height: 1.4;
      }

      .message-content code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: monospace;
        font-size: 0.875em;
      }

      .message-content pre {
        background-color: #f3f4f6;
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 0.75rem;
      }

      .message-content pre code {
        background-color: transparent;
        padding: 0;
      }

      .message-content blockquote {
        border-left: 4px solid #d1d5db;
        padding-left: 1rem;
        margin-left: 0;
        margin-bottom: 0.75rem;
        font-style: italic;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          ðŸ¤– Chatbot met MCP
        </h1>
        <p class="text-gray-600">
          Typ berichten en kijk wanneer MCP inschakelt.
        </p>
      </div>

      <!-- Connection Status -->
      <div
        id="connection-status"
        class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-6"
      >
        <strong class="font-bold">Status:</strong>
        <span class="block sm:inline">Connecting to server...</span>
      </div>

      <!-- Chat Container -->
      <div
        class="bg-white rounded-lg shadow-md flex flex-col"
        style="height: 600px"
      >
        <!-- Messages Area -->
        <div
          id="messages"
          class="flex-1 overflow-y-auto p-6 space-y-4 scroll-smooth"
        >
          <!-- Messages will be dynamically added here -->
        </div>

        <!-- Quick Replies -->
        <div
          id="quick-replies"
          class="px-6 py-2 border-t border-gray-200 hidden"
        >
          <div class="flex flex-wrap gap-2">
            <!-- Quick reply buttons will be added here -->
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-6 border-t border-gray-200">
          <div class="flex space-x-4">
            <input
              type="text"
              id="message-input"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Typ een bericht..."
              disabled
            />
            <button
              onclick="sendMessage()"
              id="send-button"
              class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-medium py-2 px-6 rounded-md transition duration-200"
              disabled
            >
              Verstuur
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let isConnected = false;

      const messagesContainer = document.getElementById("messages");

      // Connect to WebSocket
      function connectWebSocket() {
        try {
          ws = new WebSocket("ws://localhost:3000/ws");

          ws.onopen = function (event) {
            isConnected = true;
            updateConnectionStatus("Connected", "success");
            enableInput();
          };

          ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            handleIncomingMessage(data);
          };

          ws.onclose = function (event) {
            isConnected = false;
            updateConnectionStatus("Disconnected", "error");
            disableInput();
          };

          ws.onerror = function (error) {
            console.error("WebSocket error:", error);
            updateConnectionStatus("Connection Error", "error");
          };
        } catch (error) {
          console.error("Failed to connect:", error);
          updateConnectionStatus("Failed to Connect", "error");
        }
      }

      function updateConnectionStatus(message, type) {
        const statusDiv = document.getElementById("connection-status");
        statusDiv.className = "px-4 py-3 rounded mb-6";

        if (type === "success") {
          statusDiv.className +=
            " bg-green-100 border border-green-400 text-green-700";
        } else if (type === "error") {
          statusDiv.className +=
            " bg-red-100 border border-red-400 text-red-700";
        } else {
          statusDiv.className +=
            " bg-yellow-100 border border-yellow-400 text-yellow-700";
        }

        statusDiv.innerHTML = `<strong class="font-bold">Status:</strong> <span class="block sm:inline">${message}</span>`;
      }

      function enableInput() {
        document.getElementById("message-input").disabled = false;
        document.getElementById("send-button").disabled = false;
        document.getElementById("message-input").focus();
      }

      function disableInput() {
        document.getElementById("message-input").disabled = true;
        document.getElementById("send-button").disabled = true;
      }

      function handleIncomingMessage(data) {
        if (data.type === "debug") {
          // Handle debug messages
          addDebugMessage(data.content);
        } else {
          // Handle regular messages - check if we should append to existing message
          if (data.id && appendToExistingMessage(data.id, data.content)) {
            // Message was appended to existing one
          } else {
            // Create new message
            addMessage(data.content, "assistant", data.id);
          }

          // Handle quick replies
          if (data.quick_replies && data.quick_replies.length > 0) {
            showQuickReplies(data.quick_replies);
          } else {
            hideQuickReplies();
          }
        }

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function preprocessMarkdown(content) {
        // Fix list items that are concatenated on the same line
        // Replace " - " with "\n- " to put each list item on a new line
        let processed = content.replace(/ - /g, "\n- ");

        // Also handle cases where list items might start at the beginning with "- "
        // and ensure there's a newline before the first item if it follows other text
        processed = processed.replace(/([.!?]) - /g, "$1\n- ");

        // Fix numbered lists that might be concatenated
        processed = processed.replace(/ (\d+)\. /g, "\n$1. ");
        processed = processed.replace(/([.!?]) (\d+)\. /g, "$1\n$2. ");

        return processed;
      }

      function addMessage(content, sender, messageId = null) {
        const messageDiv = document.createElement("div");

        // Preprocess content to fix formatting issues
        const processedContent = preprocessMarkdown(content);

        // Set data-message-id if provided
        if (messageId) {
          messageDiv.setAttribute("data-message-id", messageId);
          messageDiv.setAttribute("data-raw-content", processedContent);
        }

        if (sender === "user") {
          messageDiv.className = "flex justify-end";
          messageDiv.innerHTML = `
          <div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-xs lg:max-w-md">
            <span class="message-content">${marked.parse(processedContent)}</span>
          </div>
        `;
        } else {
          messageDiv.className = "flex justify-start";
          messageDiv.innerHTML = `
          <div class="bg-gray-200 text-gray-800 rounded-lg py-2 px-4 max-w-xs lg:max-w-md">
            <span class="message-content">${marked.parse(processedContent)}</span>
          </div>
        `;
        }

        messagesContainer.appendChild(messageDiv);
      }

      function appendToExistingMessage(messageId, content) {
        const existingMessage = document.querySelector(
          `[data-message-id="${messageId}"]`,
        );
        if (existingMessage) {
          const contentSpan = existingMessage.querySelector(".message-content");
          if (contentSpan) {
            // Get existing raw content and append new content
            const currentRawContent =
              existingMessage.getAttribute("data-raw-content") || "";
            const newRawContent = currentRawContent + content;

            // Update stored raw content
            existingMessage.setAttribute("data-raw-content", newRawContent);

            // Preprocess and re-parse entire content as markdown
            const processedContent = preprocessMarkdown(newRawContent);
            existingMessage.setAttribute("data-raw-content", processedContent);
            contentSpan.innerHTML = marked.parse(processedContent);
            return true;
          }
        }
        return false;
      }

      function addDebugMessage(content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex justify-center";
        messageDiv.innerHTML = `
        <div class="bg-yellow-100 text-yellow-800 rounded-lg py-1 px-3 text-xs font-mono border-l-4 border-yellow-400">
          <span class="font-bold text-yellow-900">DEBUG:</span> ${escapeHtml(content)}
        </div>
      `;
        messagesContainer.appendChild(messageDiv);
      }

      function showQuickReplies(replies) {
        const quickRepliesContainer = document.getElementById("quick-replies");
        const buttonsContainer = quickRepliesContainer.querySelector("div");

        // Clear existing buttons
        buttonsContainer.innerHTML = "";

        // Add new buttons
        replies.forEach((reply) => {
          const button = document.createElement("button");
          button.className =
            "bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded-full text-sm transition duration-200";
          button.textContent = reply;
          button.onclick = () => sendQuickReply(reply);
          buttonsContainer.appendChild(button);
        });

        quickRepliesContainer.classList.remove("hidden");
      }

      function hideQuickReplies() {
        document.getElementById("quick-replies").classList.add("hidden");
      }

      function sendQuickReply(content) {
        sendTextMessage(content);
        hideQuickReplies();
      }

      function sendMessage() {
        const input = document.getElementById("message-input");
        const content = input.value.trim();

        if (!content || !isConnected) return;

        sendTextMessage(content);
        input.value = "";
      }

      function sendTextMessage(content) {
        if (!isConnected) return;

        // Add user message to UI
        addMessage(content, "user");

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Send to WebSocket
        const message = {
          type: "text",
          content: content,
        };

        ws.send(JSON.stringify(message));
      }

      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, function (m) {
          return map[m];
        });
      }

      // Handle Enter key in input
      document
        .getElementById("message-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Connect when page loads
      window.addEventListener("load", function () {
        connectWebSocket();
      });
    </script>
  </body>
</html>
